rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Admin check function (운영자: 책 삭제, 공지 관리 등)
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email == 'admin@odok.app' ||
        request.auth.token.email.matches('.*banlan21.*')
      );
    }

    // Authenticated check
    function isAuth() {
      return request.auth != null;
    }

    // Owner check
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // artifacts Collection (Main App Data)
    match /artifacts/{appId} {
      // 1. Users Collection
      match /users/{userId} {
        // User Profile Info
        match /profile/info {
          allow read: if true;
          allow write: if isOwner(userId);
          // 잉크 선물: 다른 유저가 ink 필드만 변경 허용
          allow update: if isAuth() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ink']);
        }

        // Ink History (잉크 선물 기록)
        match /ink_history/{historyId} {
          allow read: if isOwner(userId);
          allow create: if isAuth();
        }

        // Story Rewards
        match /story_rewards/{rewardId} {
          allow read, write: if isOwner(userId);
        }

        // Unlocked Stories
        match /unlocked_stories/{storyId} {
          allow read, write: if isOwner(userId);
        }

        // Other user subcollections
        match /{document=**} {
          allow read, write: if isOwner(userId);
        }
      }

      // 2. Books Collection (User Generated Content)
      match /books/{bookId} {
        allow read: if true;
        allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
        allow update: if isAuth();
        allow delete: if isAuth() && (resource.data.authorId == request.auth.uid || isAdmin());
      }

      // 3. Public Data Collection
      match /public/data {
        // Comments (ReaderView)
        match /comments/{commentId} {
          allow read: if true;
          allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
          allow update, delete: if isAuth() && resource.data.userId == request.auth.uid;
        }

        // Book Comments (BookDetail)
        match /book_comments/{commentId} {
          allow read: if true;
          allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
          allow update, delete: if isAuth() && resource.data.userId == request.auth.uid;
        }

        // Ratings
        match /ratings/{ratingId} {
          allow read: if true;
          allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
          allow update: if isAuth() && resource.data.userId == request.auth.uid;
        }

        // Favorites
        match /favorites/{favId} {
          allow read: if true;
          allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
          allow delete: if isAuth() && resource.data.userId == request.auth.uid;
        }

        // Book Favorites
        match /book_favorites/{favId} {
          allow read: if true;
          allow write: if isAuth();
        }

        // Book Likes
        match /book_likes/{likeId} {
          allow read: if true;
          allow write: if isAuth();
        }

        // Book Completions
        match /book_completions/{completionId} {
          allow read: if true;
          allow write: if isAuth();
        }

        // Stories (AI Generated)
        match /stories/{storyId} {
          allow read: if true;
          allow create: if isAuth();
          allow update: if isAuth() && (resource.data.authorId == request.auth.uid || isAdmin());
        }

        // Reports
        match /reports/{reportId} {
          allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
          allow read: if isAuth() && (resource.data.userId == request.auth.uid || isAdmin());
        }

        // Series Votes
        match /series_votes/{voteId} {
          allow read: if true;
          allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
        }

        // Daily Series Slot
        match /daily_series_slot/{dateKey} {
          allow read: if true;
          allow write: if isAuth();
        }
      }
    }

    // Global Notices Collection
    match /notices/{noticeId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
