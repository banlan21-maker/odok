# Firebase Functions 환경 변수 확인 및 설정 가이드

## 프로젝트 정보
- 프로젝트 ID: `odok-odok-final`
- Functions 리전: `asia-northeast3`

## 2번 확인: Firebase Console 환경 변수 확인

### 방법 1: Firebase Console (웹 UI)

1. **Firebase Console 접속**
   - https://console.firebase.google.com 접속
   - 프로젝트 `odok-odok-final` 선택

2. **Functions 페이지로 이동**
   - 왼쪽 메뉴에서 **Functions** 클릭
   - 또는 URL: https://console.firebase.google.com/project/odok-odok-final/functions

3. **환경 변수 확인**
   - Functions 페이지 상단에 **"환경 변수"** 또는 **"Environment variables"** 탭이 있는지 확인
   - 또는 Functions 목록에서 특정 함수를 선택하고 설정 탭에서 환경 변수 확인

4. **환경 변수 설정 (없는 경우)**
   - 변수 이름: `GEMINI_API_KEY`
   - 변수 값: `<YOUR_GEMINI_API_KEY>`

### 방법 2: Firebase CLI로 확인

터미널에서 다음 명령어 실행:

```bash
# 프로젝트 디렉토리에서
cd functions

# 환경 변수 확인 (Functions v1 방식)
firebase functions:config:get

# Functions v2에서는 Secrets를 사용할 수도 있음
firebase functions:secrets:access GEMINI_API_KEY
```

### 주의사항

이 프로젝트의 Functions 코드는 `process.env.GEMINI_API_KEY` 를 읽습니다.  
따라서 **Functions 런타임 환경 변수**로 `GEMINI_API_KEY`(또는 `GOOGLE_GENERATIVE_AI_API_KEY`)를 설정해야 합니다.

> 실수로 키를 저장소에 커밋하지 않도록 `.env`/`.local` 파일은 반드시 `.gitignore`에 포함하세요.

## 3번 확인: Functions 재배포

### 배포 상태 확인

1. **Firebase Console에서 확인**
   - Functions 페이지에서 배포된 함수 목록 확인
   - `generateBookAI` 함수가 있는지 확인
   - 최근 배포 시간 확인

2. **CLI로 재배포**

```bash
# 프로젝트 루트 디렉토리에서
cd functions

# Functions 재배포
firebase deploy --only functions

# 또는 특정 함수만 배포
firebase deploy --only functions:generateBookAI
```

### 배포 후 확인사항

1. 배포가 성공했는지 확인
2. Functions 로그에서 API 키 확인 메시지 확인
3. 실제로 책 생성 기능 테스트

---

## 로컬 개발 환경 변수 설정

Functions 에뮬레이터 실행 전에 환경 변수를 터미널에 세팅합니다.

**PowerShell**
```powershell
$env:GEMINI_API_KEY="your-key"
cd functions
firebase emulators:start --only functions
```

**bash/zsh**
```bash
export GEMINI_API_KEY="your-key"
cd functions
firebase emulators:start --only functions
```

---

## GitHub Actions 자동 배포용 설정

자동 배포 워크플로우는 다음 시크릿이 필요합니다.

### 웹 앱 빌드용 (필수 – 없으면 흰 화면 / auth/invalid-api-key)

GitHub 저장소 → **Settings → Secrets and variables → Actions** 에 다음 시크릿 추가:

| 시크릿 이름 | 설명 |
|-------------|------|
| `VITE_FIREBASE_API_KEY` | Firebase API 키 |
| `VITE_FIREBASE_AUTH_DOMAIN` | odok-odok-final.firebaseapp.com |
| `VITE_FIREBASE_PROJECT_ID` | odok-odok-final |
| `VITE_FIREBASE_STORAGE_BUCKET` | odok-odok-final.firebasestorage.app |
| `VITE_FIREBASE_MESSAGING_SENDER_ID` | 숫자 |
| `VITE_FIREBASE_APP_ID` | 1:38540467550:web:... |

> Firebase Console → 프로젝트 설정 → 일반 → 앱 → 웹 앱 에서 값을 복사할 수 있습니다.

### Functions 배포용

| 시크릿 이름 | 설명 |
|-------------|------|
| `FIREBASE_SERVICE_ACCOUNT` | 서비스 계정 JSON 전체 (Google Cloud Console에서 생성) |

---

## auth/invalid-api-key 오류 해결

흰 화면 + `auth/invalid-api-key` 발생 시:

1. **배포 사이트인 경우**
   - GitHub Secrets에 `VITE_FIREBASE_*` 6개가 모두 설정되어 있는지 확인
   - 설정 후 푸시해서 다시 빌드·배포

2. **로컬 실행인 경우**
   - 프로젝트 루트에 `.env` 파일 존재 확인
   - `VITE_FIREBASE_API_KEY=AIzaSy...` 형식으로 값이 들어 있는지 확인
   - 변경 후 `npm run dev` 재시작

3. **API 키 제한**
   - [Google Cloud Console](https://console.cloud.google.com/) → API 및 서비스 → 사용자 인증 정보
   - 해당 API 키 → 애플리케이션 제한사항
   - HTTP referrer에 접속 URL 추가 (예: `https://odok-odok-final.web.app/*`, `http://localhost:*`)
